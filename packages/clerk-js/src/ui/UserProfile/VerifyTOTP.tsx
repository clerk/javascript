import React from 'react';

import { useCoreUser } from '../contexts';
import { Col } from '../customizables';
import { useCardState, useCodeControl } from '../elements';
import { CodeForm } from '../elements/CodeForm';
import { useLoadingStatus } from '../hooks';
import { handleError, sleep, useFormControl } from '../utils';
import { FormButtonContainer } from './FormButtons';
import { NavigateToFlowStartButton } from './NavigateToFlowStartButton';
import { ContentPage } from './Page';

type VerifyTOTPProps = {
  title: string;
  onVerified: () => void;
};

export const VerifyTOTP = (props: VerifyTOTPProps) => {
  const { title, onVerified } = props;
  const card = useCardState();
  const user = useCoreUser();
  const status = useLoadingStatus();
  const [success, setSuccess] = React.useState(false);
  const codeControlState = useFormControl('code', '');
  const codeControl = useCodeControl(codeControlState);

  const resolve = async () => {
    setSuccess(true);
    await sleep(750);
    onVerified();
  };

  const reject = async (err: any) => {
    handleError(err, [codeControlState], card.setError);
    status.setIdle();
    await sleep(750);
    codeControl.reset();
  };

  codeControl.onCodeEntryFinished(code => {
    status.setLoading();
    codeControlState.setError(undefined);
    return user
      .verifyTOTP({ code })
      .then(() => resolve())
      .catch(reject);
  });

  return (
    <ContentPage.Root headerTitle={title}>
      <Col>
        <CodeForm
          title={'Verification code'}
          subtitle={'Enter verification code generated by your authenticator'}
          isLoading={status.isLoading}
          success={success}
          codeControl={codeControl}
        />
      </Col>

      <FormButtonContainer sx={{ marginTop: 0 }}>
        <NavigateToFlowStartButton>Cancel</NavigateToFlowStartButton>
      </FormButtonContainer>
    </ContentPage.Root>
  );
};
