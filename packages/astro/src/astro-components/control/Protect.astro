---
import ProtectCSR from "./ProtectCSR.astro";
import ProtectSSR from "./ProtectSSR.astro";

// @ts-expect-error: Virtual module
import { isStaticOutput } from "virtual:@clerk/astro/config";

import type {
  CheckAuthorizationWithCustomPermissions,
  OrganizationCustomPermissionKey,
  OrganizationCustomRoleKey,
} from "@clerk/types";

// @ts-expect-error: Virtual module
import { isStaticOutput } from "virtual:@clerk/astro/config";

type ProtectProps =
  | {
      condition?: never;
      role: OrganizationCustomRoleKey;
      permission?: never;
    }
  | {
      condition?: never;
      role?: never;
      permission: OrganizationCustomPermissionKey;
    }
  | {
      condition: (has: CheckAuthorizationWithCustomPermissions) => boolean;
      role?: never;
      permission?: never;
    }
  | {
      condition?: never;
      role?: never;
      permission?: never;
    };

type Props = ProtectProps & {
  isStatic?: boolean
}

const { isStatic, ...props } = Astro.props;

const ProtectComponent = isStaticOutput(isStatic) ? ProtectCSR : ProtectSSR;
---

<ProtectComponent {...props}>
  <slot />
  <slot name="fallback" slot="fallback" />
</ProtectComponent>
