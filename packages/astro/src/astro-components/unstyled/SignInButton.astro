---
import type { HTMLTag, Polymorphic } from 'astro/types'
import type { SignInProps } from "@clerk/types";
type Props<Tag extends HTMLTag> = Polymorphic<SignInProps & { as: Tag; id?: string; mode?: 'redirect' | 'modal' }>

import { customAlphabet, urlAlphabet } from "nanoid";

const safeId = customAlphabet(urlAlphabet, 10)();

const { as: Element = 'button', id = safeId, ...props } = Astro.props
---

<Element id={id}>
  <slot />
</Element >

<script is:inline define:vars={{ props, safeId }}>
  const btn = document.querySelector(`#${safeId}`);

  btn.addEventListener("click", () => {
    const {
      forceRedirectUrl,
      fallbackRedirectUrl,
      signUpFallbackRedirectUrl,
      signUpForceRedirectUrl,
      mode
    } = props;

    const opts = {
      forceRedirectUrl,
      fallbackRedirectUrl,
      signUpFallbackRedirectUrl,
      signUpForceRedirectUrl,
    };

    const clerk = window.Clerk

    if (mode === 'modal') {
      return clerk.openSignIn(opts);
    }

    return clerk.redirectToSignIn({
      ...opts,
      signInFallbackRedirectUrl: fallbackRedirectUrl,
      signInForceRedirectUrl: forceRedirectUrl,
    });
  });
</script>
