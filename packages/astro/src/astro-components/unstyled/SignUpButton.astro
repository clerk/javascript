---
import type { HTMLTag, Polymorphic } from 'astro/types'
import type { SignUpProps } from "@clerk/types";
type Props<Tag extends HTMLTag> = Polymorphic<SignUpProps & { as: Tag; id?: string; mode?: 'redirect' | 'modal' }>

import { customAlphabet, urlAlphabet } from "nanoid";

const safeId = customAlphabet(urlAlphabet, 10)();

const {
  as: Tag = 'button',
  id = safeId,
  fallbackRedirectUrl,
  forceRedirectUrl,
  signInFallbackRedirectUrl,
  signInForceRedirectUrl,
  mode,
  unsafeMetadata,
  ...elementProps
} = Astro.props

const signUpOptions = {
  fallbackRedirectUrl,
  forceRedirectUrl,
  signInFallbackRedirectUrl,
  signInForceRedirectUrl,
  unsafeMetadata,
}
---

<Tag {...elementProps} id={id}>
  <slot>Sign up</slot>
</Tag >

<script is:inline define:vars={{ signUpOptions, mode, safeId }}>
  const btn = document.querySelector(`#${safeId}`);

  btn.addEventListener("click", () => {
    const clerk = window.Clerk

    if (mode === 'modal') {
      return clerk.openSignUp(signUpOptions);
    }

    return clerk.redirectToSignUp({
      ...signUpOptions,
      signUpFallbackRedirectUrl: signUpOptions.fallbackRedirectUrl,
      signUpForceRedirectUrl: signUpOptions.forceRedirectUrl,
    });
  });
</script>
