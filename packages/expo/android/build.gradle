plugins {
  id 'com.android.library'
  id 'org.jetbrains.kotlin.android'
  id 'org.jetbrains.kotlin.plugin.compose' version '2.1.20'
}

group = 'com.clerk.expo'
version = '1.0.0'

// Dependency versions - centralized for easier updates
ext {
  credentialsVersion = "1.3.0"
  googleIdVersion = "1.1.1"
  kotlinxCoroutinesVersion = "1.7.3"
  // Clerk Android SDK versions (from local Maven)
  clerkApiVersion = "0.1.28"
  clerkUiVersion = "0.1.3"
  // Compose BOM version (must match clerk-android)
  composeBomVersion = "2025.01.00"
  // OkHttp version (required by clerk-android)
  okhttpVersion = "4.12.0"
  // Ktor version (must use 3.1.x which uses OkHttp 4.x, compatible with React Native)
  // Ktor 3.3.x uses OkHttp 5.x which has incompatible internal APIs
  ktorVersion = "3.1.3"
}

def safeExtGet(prop, fallback) {
  rootProject.ext.has(prop) ? rootProject.ext.get(prop) : fallback
}

repositories {
  mavenLocal() // Use local Maven repository for clerk-android SDK
}

android {
  namespace "expo.modules.clerk"

  compileSdk safeExtGet("compileSdkVersion", 36)

  defaultConfig {
    minSdk safeExtGet("minSdkVersion", 24)
    targetSdk safeExtGet("targetSdkVersion", 36)
    versionCode 1
    versionName "1.0.0"
  }

  buildTypes {
    release {
      minifyEnabled false
    }
  }

  buildFeatures {
    compose true
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_17
    targetCompatibility JavaVersion.VERSION_17
  }

  kotlinOptions {
    jvmTarget = "17"
  }

  sourceSets {
    main {
      java.srcDirs = ['src/main/java']
    }
  }
}

dependencies {
  // Expo modules core
  implementation project(':expo-modules-core')

  // Clerk Android SDK (from local Maven)
  implementation "com.clerk:clerk-android-api:$clerkApiVersion"
  implementation "com.clerk:clerk-android-ui:$clerkUiVersion"

  // Compose BOM and dependencies
  implementation platform("androidx.compose:compose-bom:$composeBomVersion")
  implementation "androidx.compose.ui:ui"
  implementation "androidx.compose.foundation:foundation"
  implementation "androidx.compose.material3:material3"
  implementation "androidx.activity:activity-compose:1.10.0"
  implementation "androidx.lifecycle:lifecycle-runtime-compose:2.8.7"

  // Credential Manager for Google Sign-In with nonce support
  implementation "androidx.credentials:credentials:$credentialsVersion"
  implementation "androidx.credentials:credentials-play-services-auth:$credentialsVersion"
  implementation "com.google.android.libraries.identity.googleid:googleid:$googleIdVersion"

  // Coroutines for async operations
  implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:$kotlinxCoroutinesVersion"

  // Ktor (required by clerk-android)
  implementation "io.ktor:ktor-client-okhttp:$ktorVersion"

  // Explicit OkHttp dependencies to ensure version consistency
  // This fixes the okhttp3.internal.Util ClassNotFoundException
  implementation "com.squareup.okhttp3:okhttp:$okhttpVersion"
  implementation "com.squareup.okhttp3:okhttp-urlconnection:$okhttpVersion"
}
