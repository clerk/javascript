plugins {
  id 'com.android.library'
  id 'org.jetbrains.kotlin.android'
  id 'org.jetbrains.kotlin.plugin.compose' version '2.1.20'
}

group = 'com.clerk.expo'
version = '1.0.0'

// Dependency versions - centralized for easier updates
// See: https://docs.gradle.org/current/userguide/version_catalogs.html for app-level version catalogs
ext {
  credentialsVersion = "1.3.0"
  googleIdVersion = "1.1.1"
  kotlinxCoroutinesVersion = "1.7.3"
  clerkAndroidApiVersion = "0.1.30"
  clerkAndroidUiVersion = "0.1.4"
  composeVersion = "1.7.0"
  activityComposeVersion = "1.9.0"
  lifecycleVersion = "2.8.0"
}

def safeExtGet(prop, fallback) {
  rootProject.ext.has(prop) ? rootProject.ext.get(prop) : fallback
}

android {
  namespace "expo.modules.clerk"

  compileSdk safeExtGet("compileSdkVersion", 36)

  defaultConfig {
    minSdk safeExtGet("minSdkVersion", 24)
    targetSdk safeExtGet("targetSdkVersion", 36)
    versionCode 1
    versionName "1.0.0"
  }

  buildTypes {
    release {
      minifyEnabled false
    }
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_17
    targetCompatibility JavaVersion.VERSION_17
  }

  kotlinOptions {
    jvmTarget = "17"
    // Skip Kotlin metadata version check to work around clerk-android being compiled with Kotlin 2.3.0
    // while Expo uses Kotlin 2.1.20. This is a temporary workaround until clerk-android publishes
    // artifacts compatible with Kotlin 2.1.x
    freeCompilerArgs += ["-Xskip-metadata-version-check"]
  }

  buildFeatures {
    compose = true
  }

  packaging {
    resources {
      excludes += ['META-INF/versions/9/OSGI-INF/MANIFEST.MF']
    }
  }

  sourceSets {
    main {
      java.srcDirs = ['src/main/java']
    }
  }
}

// Note: kotlin-stdlib exclusions are handled in the clerk-android-ui dependency declaration

dependencies {
  // Expo modules core
  implementation project(':expo-modules-core')

  // Credential Manager for Google Sign-In with nonce support
  implementation "androidx.credentials:credentials:$credentialsVersion"
  implementation "androidx.credentials:credentials-play-services-auth:$credentialsVersion"
  implementation "com.google.android.libraries.identity.googleid:googleid:$googleIdVersion"

  // Coroutines for async operations
  implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:$kotlinxCoroutinesVersion"

  // Clerk Android SDK with prebuilt UI
  // Exclude kotlin-stdlib to prevent 2.3.0 from polluting the project
  // Exclude okhttp to prevent version conflict with React Native's okhttp
  implementation("com.clerk:clerk-android-ui:$clerkAndroidUiVersion") {
    exclude group: 'org.jetbrains.kotlin', module: 'kotlin-stdlib'
    exclude group: 'org.jetbrains.kotlin', module: 'kotlin-stdlib-jdk7'
    exclude group: 'org.jetbrains.kotlin', module: 'kotlin-stdlib-jdk8'
    exclude group: 'com.squareup.okhttp3', module: 'okhttp'
    exclude group: 'com.squareup.okhttp3', module: 'okhttp-urlconnection'
  }

  // Jetpack Compose for wrapping Clerk views
  implementation "androidx.compose.ui:ui:$composeVersion"
  implementation "androidx.compose.material3:material3:1.3.0"
  implementation "androidx.activity:activity-compose:$activityComposeVersion"
  implementation "androidx.lifecycle:lifecycle-runtime-compose:$lifecycleVersion"
}
