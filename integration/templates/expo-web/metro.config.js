/**
 * DO NOT EDIT THIS FILE UNLESS YOU DEFINITELY KNWO WHAT YOU ARE DOING.
 * THIS ENSURES THAT INTEGRATION TESTS ARE LOADING THE CORRECT DEPENDENCIES.
 */
const { getDefaultConfig } = require('expo/metro-config');
const packageJson = require('./package.json');
const path = require('node:path');

/** @type {() => string | undefined} */
const getClerkExpoPath = () => {
  const clerkExpoPath = packageJson.dependencies['@clerk/clerk-expo'];

  if (clerkExpoPath?.startsWith('*')) {
    const pathToModule = require.resolve('@clerk/clerk-expo');
    return pathToModule.replace('dist/index.js', '');
  }

  if (clerkExpoPath?.startsWith('file:')) {
    return clerkExpoPath.replace('file:', '');
  }

  if (clerkExpoPath?.startsWith('link:')) {
    return clerkExpoPath.replace('link:', '');
  }

  return undefined;
};

const clerkExpoPath = getClerkExpoPath();
const clerkMonorepoPath = clerkExpoPath?.replace(/\/packages\/expo$/, '');

/** @type {import('expo/metro-config').MetroConfig} */
const config = getDefaultConfig(__dirname);

// Only customize Metro config when running from monorepo
if (clerkMonorepoPath) {
  config.watchFolders = [clerkMonorepoPath];

  // Prioritize local node_modules over monorepo node_modules
  config.resolver.nodeModulesPaths = [path.resolve(__dirname, 'node_modules'), `${clerkMonorepoPath}/node_modules`];

  // Explicitly map @clerk packages to their source locations
  // Point to the root of the package so Metro can properly resolve subpath exports
  config.resolver.extraNodeModules = {
    '@clerk/clerk-react': path.resolve(clerkMonorepoPath, 'packages/react'),
    '@clerk/clerk-expo': path.resolve(clerkMonorepoPath, 'packages/expo'),
    '@clerk/shared': path.resolve(clerkMonorepoPath, 'packages/shared'),
    '@clerk/types': path.resolve(clerkMonorepoPath, 'packages/types'),
  };

  // This is a workaround to prevent multiple versions of react and react-native from being loaded.
  // Block React/React-Native in both monorepo root and all package node_modules
  // Use word boundaries to avoid blocking clerk-react
  // https://github.com/expo/expo/pull/26209
  const escapedPath = clerkMonorepoPath.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  config.resolver.blockList = [
    // Block monorepo root node_modules for react/react-native (exact match)
    new RegExp(`${escapedPath}/node_modules/react/`),
    new RegExp(`${escapedPath}/node_modules/react$`),
    new RegExp(`${escapedPath}/node_modules/react-dom/`),
    new RegExp(`${escapedPath}/node_modules/react-dom$`),
    new RegExp(`${escapedPath}/node_modules/react-native/`),
    new RegExp(`${escapedPath}/node_modules/react-native$`),
    // Block react/react-native/react-dom in all package node_modules (exact match)
    new RegExp(`${escapedPath}/packages/.*/node_modules/react/`),
    new RegExp(`${escapedPath}/packages/.*/node_modules/react$`),
    new RegExp(`${escapedPath}/packages/.*/node_modules/react-dom/`),
    new RegExp(`${escapedPath}/packages/.*/node_modules/react-dom$`),
    new RegExp(`${escapedPath}/packages/.*/node_modules/react-native/`),
    new RegExp(`${escapedPath}/packages/.*/node_modules/react-native$`),
  ];
}

module.exports = config;
