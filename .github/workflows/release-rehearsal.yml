name: Release Rehearsal

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - '.changeset/**'
      - '.github/workflows/release-rehearsal.yml'
  push:
    branches: [main]

concurrency:
  group: release-rehearsal-${{ github.ref }}
  cancel-in-progress: true

jobs:
  rehearse:
    name: Release Rehearsal
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 100
          fetch-tags: false
          filter: 'blob:none'
          show-progress: false

      - name: Fetch main branch for changeset comparison
        run: git fetch origin main:refs/remotes/origin/main --depth=100

      - name: Setup
        uses: ./.github/actions/init
        with:
          turbo-team: ''
          turbo-token: ''

      # 1) Validate changesets against base branch
      - name: Changeset status
        run: pnpm changeset status --output .changeset-status.json

      # 2) Build (same path as production releases)
      - name: Build
        run: pnpm build

      # 3) Rehearse versioning (uses existing script: changeset version + lockfile update)
      - name: Version packages (rehearsal)
        run: pnpm version-packages
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # 4) Fail on unexpected file changes after versioning
      - name: Post-version diff guard
        run: |
          UNEXPECTED=$(git diff --name-only | grep -Ev '^(\.changeset/|package\.json$|pnpm-lock\.yaml$|packages/.*/package\.json$|packages/.*/CHANGELOG\.md$)' || true)
          if [ -n "$UNEXPECTED" ]; then
            echo "::error::Unexpected files changed after versioning:"
            echo "$UNEXPECTED"
            exit 1
          fi

      # 5) Simulate publish by packing all public packages
      - name: Pack public packages
        run: |
          mkdir -p .release-artifacts
          pnpm -r exec -- sh -c '
            if [ "$(node -p "Boolean(require(\"./package.json\").private)")" = "true" ]; then
              echo "Skipping private package: $(node -p "require(\"./package.json\").name")"
            else
              npm pack --json
            fi
          ' > .release-artifacts/pack-output.json 2>&1

      - name: Upload rehearsal artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-rehearsal-artifacts
          path: |
            .changeset-status.json
            .release-artifacts/pack-output.json
