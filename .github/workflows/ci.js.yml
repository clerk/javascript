name: Clerk Javascript CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUNDLEWATCH_GITHUB_TOKEN: ${{ secrets.BUNDLEWATCH_GITHUB_TOKEN }}
  CACHE_VERSION: 1 # increment to bust all caches
  CI_BRANCH: ${{ github.ref	}}
  CI_BRANCH_BASE: refs/heads/develop
  CI_COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
  CI_REPO_NAME: javascript
  CI_REPO_OWNER: clerkinc
  NPM_VERSION: 8.19.0
  TURBO_CACHE_DIR: .turbo
  # TURBO_CONCURRENCY: 2

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.19, 18.15, 19.8]

    env:
      NODE_VERSION: ${{ matrix.node-version }}

    steps:
      - name: Checkout ${{ env.CI_REPO_OWNER }}/${{ env.CI_REPO_NAME }}
        uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - name: Cache dependencies
        id: cache-node-modules
        uses: actions/cache@v3
        with:
          path: ./node_modules
          key: ${{ runner.os }}-node-modules-${{ matrix.node-version }}-${{ env.NPM_VERSION }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-${{ matrix.node-version }}-${{ env.NPM_VERSION }}-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-node-modules-${{ matrix.node-version }}-${{ env.NPM_VERSION }}-

      - name: Cache Turborepo outputs
        id: cache-turbo
        uses: actions/cache@v3
        with:
          path: ${{ env.TURBO_CACHE_DIR }}
          key: ${{ runner.os }}-turbo-${{ matrix.node-version }}-${{ env.NPM_VERSION }}-${{ env.CACHE_VERSION }}-${{ github.ref	}}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-${{ matrix.node-version }}-${{ env.NPM_VERSION }}-${{ env.CACHE_VERSION }}-${{ github.ref	}}-
            ${{ runner.os }}-turbo-${{ matrix.node-version }}-${{ env.NPM_VERSION }}-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-turbo-${{ matrix.node-version }}-${{ env.NPM_VERSION }}-

      - name: Install npm@${{ env.NPM_VERSION }}
        run: npm i -g npm@${{ env.NPM_VERSION }}

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm install # --prefer-offline

      - name: Build packages
        run: npm run build -- --cache-dir=${{ env.TURBO_CACHE_DIR }}

      - name: Run tests
        run: npm run test -- --cache-dir=${{ env.TURBO_CACHE_DIR }}
